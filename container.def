Bootstrap: docker
From: python:3.10-slim

%files
    pyproject.toml /opt/piper_arm/pyproject.toml
    uv.lock /opt/piper_arm/uv.lock
    README.md /opt/piper_arm/README.md
    piper_arm /opt/piper_arm/piper_arm

    # To get EGL working
    egl_vendor.d/10_nvidia.json /usr/share/glvnd/egl_vendor.d/10_nvidia.json

%post
    apt-get update && apt-get install -y --no-install-recommends \
        curl ffmpeg libavutil-dev libavcodec-dev libavformat-dev libswscale-dev \
        git linux-libc-dev build-essential cmake \
        libosmesa6-dev libglfw3 \
    && rm -rf /var/lib/apt/lists/*

    curl -LsSf https://astral.sh/uv/install.sh | sh
    export PATH="/root/.local/bin:$PATH"
    cd /opt/piper_arm && uv sync --frozen

%environment
    export PATH="/opt/piper_arm/.venv/bin:$PATH"
    export PYTHONDONTWRITEBYTECODE=1
    export MUJOCO_GL=egl
    export PYTHONUNBUFFERED=1
    export UV_CACHE_DIR=.cache/uv
    export HF_HOME=.cache/huggingface
    export LIBERO_CONFIG_PATH=.cache/libero
    export WANDB_CACHE_DIR=.cache/wandb

%runscript
    exec "$@"
